<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Smart Seating (Local)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- React & Related -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Drag & Drop / PDF / Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        @media print {
            @page {
                margin: 0.5cm;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Application Code Inlined for Local File Access -->
    <script type="text/babel">
        /** UTILS: Types & Constants **/
        window.Utils = {
            generateId: () => Math.random().toString(36).substr(2, 9),
            MOCK_NAMES: `Liam
Olivia
Noah
Emma
Oliver
Charlotte
Elijah
Amelia
James
Ava
William
Sophia
Benjamin
Isabella
Lucas
Mia
Henry
Evelyn
Theodore
Harper`.split('\n'),
            shuffle: (array) => {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }
        };

        /** UTILS: Algorithm **/
        (function () {
            const { shuffle } = window.Utils;
            const getNeighbors = (index, rows, cols) => {
                const neighbors = [];
                const r = Math.floor(index / cols), c = index % cols;
                const dirs = [[-1, -1], [-1, 0], [-1, 1], [0, -1], [0, 1], [1, -1], [1, 0], [1, 1]];
                dirs.forEach(([dr, dc]) => {
                    const nr = r + dr, nc = c + dc;
                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) neighbors.push(nr * cols + nc);
                });
                return neighbors;
            };
            const getImmediateNeighbors = (index, rows, cols) => {
                const neighbors = [];
                const r = Math.floor(index / cols), c = index % cols;
                const dirs = [[0, -1], [0, 1]];
                dirs.forEach(([dr, dc]) => {
                    const nr = r + dr, nc = c + dc;
                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) neighbors.push(nr * cols + nc);
                });
                return neighbors;
            };

            window.SeatingAlgorithm = {
                generate: (roster, roomConfig) => {
                    const { rows, cols } = roomConfig;
                    const totalSeats = rows * cols;
                    let currentLayout = new Array(totalSeats).fill(null);
                    const placedIds = new Set();
                    const others = [];

                    // Zones
                    const lockedFront = roster.filter(s => s.constraints.includes('lock_front'));
                    const lockedBack = roster.filter(s => s.constraints.includes('lock_back'));

                    // Place Front
                    let frontSeats = Array.from({ length: cols }, (_, i) => i); // First row
                    frontSeats = shuffle(frontSeats);
                    lockedFront.forEach(s => {
                        const seat = frontSeats.find(idx => currentLayout[idx] === null);
                        if (seat !== undefined) { currentLayout[seat] = s; placedIds.add(s.id); }
                        else others.push(s);
                    });

                    // Place Back
                    let backSeats = Array.from({ length: cols }, (_, i) => (rows - 1) * cols + i); // Last row
                    backSeats = shuffle(backSeats);
                    lockedBack.forEach(s => {
                        if (placedIds.has(s.id)) return;
                        const seat = backSeats.find(idx => currentLayout[idx] === null);
                        if (seat !== undefined) { currentLayout[seat] = s; placedIds.add(s.id); }
                        else others.push(s);
                    });

                    roster.forEach(s => { if (!placedIds.has(s.id)) others.push(s); });
                    const shuffledOthers = shuffle(others);
                    shuffledOthers.forEach(s => {
                        const emptyIdx = currentLayout.findIndex(x => x === null);
                        if (emptyIdx !== -1) currentLayout[emptyIdx] = s;
                    });

                    // Optimization
                    for (let iter = 0; iter < 1000; iter++) {
                        const score = window.SeatingAlgorithm.evaluate(currentLayout, roomConfig);
                        if (score.violations.length === 0) break;
                        const violation = score.violations[Math.floor(Math.random() * score.violations.length)];
                        // Try swap
                        const idx1 = currentLayout.indexOf(violation.student);
                        const idx2 = Math.floor(Math.random() * totalSeats);
                        if (idx1 === -1) continue;
                        const student2 = currentLayout[idx2];
                        // Don't swap locked students out of zone (simple check)
                        if (violation.student.constraints.length) continue;
                        if (student2 && student2.constraints.length) continue;

                        [currentLayout[idx1], currentLayout[idx2]] = [currentLayout[idx2], currentLayout[idx1]];
                    }
                    return currentLayout;
                },
                evaluate: (layout, roomConfig) => {
                    const { rows, cols } = roomConfig;
                    let violations = [];
                    layout.forEach((student, index) => {
                        if (!student) return;
                        // Separation
                        if (student.enemies && student.enemies.length) {
                            const neighbors = getNeighbors(index, rows, cols);
                            student.enemies.forEach(enemyId => {
                                neighbors.forEach(nIdx => {
                                    if (layout[nIdx] && layout[nIdx].id === enemyId) violations.push({ student, type: 'separation' });
                                });
                            });
                        }
                    });
                    return { violations };
                }
            };
        })();

        /** COMPONENT: Icon **/
        window.Icon = ({ name, size = 20, className = "", ...props }) => {
            const { useEffect, useRef } = React;
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        root: ref.current,
                        icons: { [name]: window.lucide.icons[name] },
                        attrs: { width: size, height: size, class: className, ...props }
                    });
                }
            }, [name, size, className]);
            // Use a container span for Lucide to inject into
            return <i ref={ref} data-lucide={name} className={className}></i>;
        };

        /** COMPONENT: StudentCard **/
        window.StudentCard = ({ student, onEdit }) => {
            return (
                <div
                    className="p-3 select-none bg-white rounded-lg border border-slate-200 shadow-sm flex items-center justify-between group hover:border-brand-300 transition-all cursor-grab active:cursor-grabbing"
                    draggable="true"
                    onDragStart={(e) => {
                        e.dataTransfer.setData('type', 'sidebar_student');
                        e.dataTransfer.setData('studentId', student.id);
                    }}
                >
                    <div className="flex items-center gap-3 min-w-0">
                        <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-brand-600 font-bold shrink-0">
                            {student.name.substring(0, 2).toUpperCase()}
                        </div>
                        <div className="min-w-0">
                            <div className="font-medium text-slate-900 truncate">{student.name}</div>
                            {student.constraints && student.constraints.length > 0 && (
                                <div className="flex gap-1 mt-0.5 flex-wrap">
                                    {student.constraints.includes('lock_front') && <span className="text-[10px] text-amber-600 bg-amber-50 px-1 rounded">Front</span>}
                                    {student.constraints.includes('lock_back') && <span className="text-[10px] text-purple-600 bg-purple-50 px-1 rounded">Back</span>}
                                    {student.enemies && student.enemies.length > 0 && <span className="text-[10px] text-red-600 bg-red-50 px-1 rounded">Sep</span>}
                                </div>
                            )}
                        </div>
                    </div>
                    <button onClick={(e) => { e.stopPropagation(); onEdit(student); }} className="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded transition-colors" title="Settings">
                        <window.Icon name="settings" size={18} />
                    </button>
                </div>
            );
        };

        /** COMPONENT: GridMap **/
        window.GridMap = ({ layout, roomConfig, onSwap, onAssign, selection }) => {
            const { rows, cols, grouping } = roomConfig;

            const handleDrop = (e, targetIndex) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                if (type === 'sidebar_student') {
                    onAssign(e.dataTransfer.getData('studentId'), targetIndex);
                } else if (type === 'seat') {
                    const sourceIndex = parseInt(e.dataTransfer.getData('currIndex'));
                    if (sourceIndex !== targetIndex) onSwap(sourceIndex, targetIndex);
                }
            };

            const gridItems = [];
            let gridColsConfig = '';

            for (let c = 0; c < cols; c++) {
                gridColsConfig += 'minmax(0, 1fr) ';
                if (c < cols - 1) {
                    if ((grouping === 'Pairs' || grouping === 'Groups of 4') && (c + 1) % 2 === 0) {
                        gridColsConfig += '40px '; // Wide Gap
                    } else {
                        gridColsConfig += '10px '; // Standard Gap
                    }
                }
            }

            // Generate Items with Spacers
            for (let i = 0; i < layout.length; i++) {
                const r = Math.floor(i / cols);
                const c = i % cols;

                gridItems.push(
                    <Seat
                        key={`seat-${i}`}
                        index={i}
                        student={layout[i]}
                        onDragStart={e => {
                            e.dataTransfer.setData('currIndex', i);
                            e.dataTransfer.setData('type', 'seat');
                        }}
                        onDrop={e => handleDrop(e, i)}
                        isSelected={selection && selection.includes(i)}
                        roomConfig={roomConfig}
                    />
                );

                // If not last col, add spacer div
                if (c < cols - 1) {
                    const isWide = (grouping === 'Pairs' || grouping === 'Groups of 4') && (c + 1) % 2 === 0;
                    if (isWide) {
                        gridItems.push(<div key={`sp-h-${i}`} className="w-full h-full"></div>); // Empty div to occupy the wide gap column
                    } else {
                        gridItems.push(<div key={`sp-h-${i}`} className="w-full h-full"></div>); // Empty div to occupy the standard gap column
                    }
                }
            }

            return (
                <div className="grid p-6 bg-white rounded-xl border border-slate-200 shadow-sm print:shadow-none print:border-none print:bg-transparent"
                    style={{
                        gridTemplateColumns: gridColsConfig,
                        rowGap: '10px'
                    }}>
                    {gridItems}
                </div>
            );
        };

        // Helper Seat Component
        const Seat = ({ index, student, onDragStart, onDrop, isSelected, roomConfig }) => {
            const { rows, cols, grouping } = roomConfig;
            const r = Math.floor(index / cols);
            const isIslandBottom = grouping === 'Groups of 4' && (r + 1) % 2 === 0 && r < rows - 1;

            return (
                <div
                    className={`relative min-h-[100px] rounded-lg border-2 flex flex-col items-center justify-center p-2 text-center transition-all cursor-move
                        ${student ? (isSelected ? 'bg-red-50 border-red-400 z-10' : 'bg-white border-slate-200 hover:border-brand-400 hover:shadow-md') : 'bg-slate-50 border-dashed border-slate-200 hover:bg-slate-100'}`}
                    style={{ marginBottom: isIslandBottom ? '40px' : '0' }}
                    draggable="true"
                    onDragStart={onDragStart}
                    onDragOver={(e) => e.preventDefault()}
                    onDrop={onDrop}
                >
                    {student ? (
                        <>
                            <div className="w-8 h-8 rounded-full bg-brand-100 text-brand-700 flex items-center justify-center font-bold mb-2">
                                {student.name.substring(0, 2).toUpperCase()}
                            </div>
                            <div className="font-semibold text-slate-800 text-sm leading-tight line-clamp-2">{student.name}</div>
                            <div className="absolute top-2 right-2 flex flex-col gap-1">
                                {student.constraints.includes('lock_front') && <div className="w-1.5 h-1.5 rounded-full bg-amber-500"></div>}
                                {student.constraints.includes('lock_back') && <div className="w-1.5 h-1.5 rounded-full bg-purple-500"></div>}
                            </div>
                        </>
                    ) : <span className="text-xs font-bold text-slate-300 select-none">{index + 1}</span>}
                </div>
            );
        };

        /** COMPONENT: Sidebar **/
        window.Sidebar = ({ students, unassigned, onImport, onUpdateStudent, roomConfig, onUpdateConfig, onGenerate }) => {
            const [tab, setTab] = React.useState('roster');
            const [importText, setImportText] = React.useState('');
            const [editingId, setEditingId] = React.useState(null);

            const handleImport = () => {
                const names = importText.split('\n').filter(n => n.trim().length > 0);
                if (names.length) onImport(names);
                setImportText('');
            };

            return (
                <div className="w-80 flex flex-col bg-white border-r border-slate-200 h-screen overflow-hidden print:hidden fixed left-0 top-0 bottom-0 z-40">
                    <div className="p-4 border-b border-slate-100 flex items-center justify-between shrink-0">
                        <h1 className="font-bold text-slate-800 flex items-center gap-2"><window.Icon name="layout-grid" className="text-brand-600" />Classroom</h1>
                        <div className="flex bg-slate-100 rounded-lg p-1">
                            <button onClick={() => setTab('roster')} className={`p-1.5 rounded-md ${tab === 'roster' ? 'bg-white shadow text-brand-600' : ''}`}><window.Icon name="users" size={16} /></button>
                            <button onClick={() => setTab('settings')} className={`p-1.5 rounded-md ${tab === 'settings' ? 'bg-white shadow text-brand-600' : ''}`}><window.Icon name="settings-2" size={16} /></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
                        {tab === 'roster' ? (
                            <>
                                <div className="p-4 bg-brand-50 rounded-xl border border-brand-100 shadow-sm">
                                    <button onClick={onGenerate} className="w-full py-2.5 bg-brand-600 hover:bg-brand-700 text-white font-medium rounded-lg flex items-center justify-center gap-2">
                                        <window.Icon name="wand-2" size={18} /> Generate Plan
                                    </button>
                                </div>
                                <div>
                                    <div className="relative group">
                                        <textarea className="w-full p-3 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 resize-none" rows="3" placeholder="Paste names here..." value={importText} onChange={e => setImportText(e.target.value)} />
                                        <button onClick={handleImport} disabled={!importText.trim()} className="absolute bottom-2 right-2 p-1.5 bg-white text-brand-600 rounded-md shadow-sm border border-slate-100 hover:bg-brand-50" title="Add"><window.Icon name="plus" size={16} /></button>
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Roster ({unassigned.length}/{students.length})</h3>
                                    <div className="space-y-2 min-h-[100px]">
                                        {unassigned.map(s => <window.StudentCard key={s.id} student={s} onEdit={() => setEditingId(s.id)} />)}
                                        {unassigned.length === 0 && students.length > 0 && <div className="text-center py-4 text-slate-400 text-xs italic">All seated</div>}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="space-y-4">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2"><window.Icon name="grid-3x3" size={16} /> Room Settings</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="text-xs text-slate-500">Rows</label><input type="number" min="1" value={roomConfig.rows} onChange={e => onUpdateConfig('rows', +e.target.value)} className="w-full p-2 bg-slate-50 border rounded-lg" /></div>
                                    <div><label className="text-xs text-slate-500">Cols</label><input type="number" min="1" value={roomConfig.cols} onChange={e => onUpdateConfig('cols', +e.target.value)} className="w-full p-2 bg-slate-50 border rounded-lg" /></div>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-500 font-bold">Grouping Style</label>
                                    <select className="w-full p-2 bg-slate-50 border rounded-lg mt-1" value={roomConfig.grouping} onChange={e => onUpdateConfig('grouping', e.target.value)}>
                                        <option value="None">Standard Grid</option>
                                        <option value="Pairs">Pairs (2)</option>
                                        <option value="Groups of 4">Islands (Group of 4)</option>
                                    </select>
                                </div>
                            </div>
                        )}
                    </div>
                    {editingId && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setEditingId(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                                {(() => {
                                    const s = students.find(x => x.id === editingId);
                                    if (!s) return null;
                                    return (
                                        <div className="p-5 space-y-6">
                                            <div className="flex justify-between items-center"><h3 className="font-bold text-lg">{s.name}</h3><button onClick={() => setEditingId(null)}><window.Icon name="x" size={20} /></button></div>
                                            <div className="space-y-2 bg-slate-50 p-3 rounded-lg border">
                                                <label className="flex gap-2 text-sm"><input type="checkbox" checked={s.constraints.includes('lock_front')} onChange={e => onUpdateStudent(s.id, { constraints: e.target.checked ? [...s.constraints, 'lock_front'] : s.constraints.filter(x => x !== 'lock_front') })} /> Lock Front</label>
                                                <label className="flex gap-2 text-sm"><input type="checkbox" checked={s.constraints.includes('lock_back')} onChange={e => onUpdateStudent(s.id, { constraints: e.target.checked ? [...s.constraints, 'lock_back'] : s.constraints.filter(x => x !== 'lock_back') })} /> Lock Back</label>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-slate-400 uppercase">Enemies (Separation)</label>
                                                <select className="w-full p-2 border rounded-lg text-sm mt-1" onChange={e => { if (e.target.value) onUpdateStudent(s.id, { enemies: [...(s.enemies || []), e.target.value] }); e.target.value = ""; }}>
                                                    <option value="">+ Add...</option>
                                                    {students.filter(x => x.id !== s.id && !(s.enemies || []).includes(x.id)).map(o => <option key={o.id} value={o.id}>{o.name}</option>)}
                                                </select>
                                                <div className="flex flex-wrap gap-2 mt-2">
                                                    {(s.enemies || []).map(enId => {
                                                        const en = students.find(x => x.id === enId);
                                                        return <span key={enId} className="bg-red-50 text-red-700 px-2 py-1 rounded-full text-xs flex items-center gap-1">{en?.name} <button onClick={() => onUpdateStudent(s.id, { enemies: s.enemies.filter(x => x !== enId) })}>x</button></span>;
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        /** MAIN APP **/
        window.App = () => {
            const [students, setStudents] = React.useState(window.Utils.MOCK_NAMES.map(name => ({
                id: window.Utils.generateId(), name, constraints: [], enemies: []
            })));
            const [roomConfig, setRoomConfig] = React.useState({ rows: 5, cols: 6, grouping: 'None' });
            const [layout, setLayout] = React.useState([]);
            const [viewMode, setViewMode] = React.useState('editor');
            const [score, setScore] = React.useState(null);

            React.useEffect(() => {
                setLayout(prev => {
                    const newLayout = new Array(roomConfig.rows * roomConfig.cols).fill(null);
                    for (let i = 0; i < Math.min(prev.length, newLayout.length); i++) newLayout[i] = prev[i];
                    return newLayout;
                });
            }, [roomConfig.rows, roomConfig.cols]);

            const assignedIds = new Set(layout.filter(id => id !== null));
            const unassigned = students.filter(s => !assignedIds.has(s.id));

            return (
                <div className="flex h-screen w-full bg-slate-50 text-slate-900 overflow-hidden">
                    <div className={viewMode === 'projector' ? 'hidden' : 'block'}>
                        <window.Sidebar
                            students={students} unassigned={unassigned} roomConfig={roomConfig}
                            onImport={names => setStudents(p => [...p, ...names.map(name => ({ id: window.Utils.generateId(), name, constraints: [], enemies: [] }))])}
                            onUpdateStudent={(id, u) => setStudents(p => p.map(s => s.id === id ? { ...s, ...u } : s))}
                            onUpdateConfig={(k, v) => setRoomConfig(p => ({ ...p, [k]: v }))}
                            onGenerate={() => {
                                const newLayoutObjs = window.SeatingAlgorithm.generate([...students], roomConfig);
                                setLayout(newLayoutObjs.map(s => s ? s.id : null));
                                setScore(window.SeatingAlgorithm.evaluate(newLayoutObjs, roomConfig));
                            }}
                        />
                    </div>
                    <div className={`flex-1 flex flex-col h-full relative ${viewMode === 'projector' ? 'pl-0' : 'pl-80'}`}>
                        <header className="h-16 bg-white border-b border-slate-200 shadow-sm flex items-center justify-between px-6 shrink-0 print:hidden">
                            <h2 className="text-xl font-bold text-brand-600">Class 10A</h2>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setViewMode('editor')} className="px-3 py-1 text-sm font-bold text-slate-600">Editor</button>
                                <button onClick={() => setViewMode('projector')} className="px-3 py-1 text-sm font-bold text-slate-600">Projector</button>
                                <button onClick={() => window.print()} className="p-2 hover:bg-slate-100 rounded">Print</button>
                            </div>
                        </header>
                        <main className="flex-1 overflow-auto bg-slate-50/50 p-8 flex flex-col items-center">
                            <div id="seating-chart" className="w-full max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-sm border border-slate-200 min-h-[600px] print:p-0 print:border-none print:shadow-none">
                                <div className="w-full h-8 mb-8 bg-slate-100 rounded-lg flex items-center justify-center text-slate-400 text-xs font-bold uppercase tracking-[0.2em] border border-dashed border-slate-300">Front</div>
                                <window.GridMap
                                    layout={layout.map(id => students.find(s => s.id === id) || null)}
                                    roomConfig={roomConfig}
                                    onSwap={(i1, i2) => setLayout(p => { const n = [...p];[n[i1], n[i2]] = [n[i2], n[i1]]; return n; })}
                                    onAssign={(sid, idx) => setLayout(p => { const n = [...p], old = n.indexOf(sid); if (old !== -1) n[old] = null; n[idx] = sid; return n; })}
                                    selection={score ? score.violations.map(v => layout.indexOf(v.student.id)) : []}
                                />
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<window.App />);
    </script>
</body>

</html>